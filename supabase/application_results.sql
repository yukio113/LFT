create table if not exists public.application_results (
  id bigint generated by default as identity primary key,
  post_id bigint not null,
  post_title text not null,
  vc_type text,
  recruiter_user_id uuid not null references auth.users(id) on delete cascade,
  applicant_user_id uuid not null references auth.users(id) on delete cascade,
  status text not null check (status in ('selected', 'rejected')),
  ea_account_name text,
  discord_invite_link text,
  message text,
  created_at timestamptz not null default now(),
  unique (post_id, applicant_user_id)
);

alter table public.application_results
  add column if not exists vc_type text;

create index if not exists application_results_applicant_idx
  on public.application_results (applicant_user_id, created_at desc);

create index if not exists application_results_recruiter_idx
  on public.application_results (recruiter_user_id, created_at desc);

alter table public.application_results enable row level security;

drop policy if exists "Applicants can read own results" on public.application_results;
create policy "Applicants can read own results"
  on public.application_results for select
  using (auth.uid() = applicant_user_id);

drop policy if exists "Recruiters can read own sent results" on public.application_results;
create policy "Recruiters can read own sent results"
  on public.application_results for select
  using (auth.uid() = recruiter_user_id);

drop policy if exists "Recruiters can insert results for own posts" on public.application_results;
create policy "Recruiters can insert results for own posts"
  on public.application_results for insert
  with check (
    auth.uid() = recruiter_user_id
    and exists (
      select 1
      from public.posts p
      where p.id = application_results.post_id
        and p.user_id::text = auth.uid()::text
    )
    and exists (
      select 1
      from public.applications a
      where a.post_id = application_results.post_id
        and a.applicant_user_id::text = application_results.applicant_user_id::text
    )
  );
